<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìŠ¤íŠ¸ë¦¼ìŠ¤ ê²Œì„ - ê³µìœ  ë­í‚¹(ì „ì²´/ì›”ë³„)</title>
  <style>
    body { background:#fff; color:#000; font-family:system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Malgun Gothic, Arial, sans-serif; text-align:center; margin:0; padding:0 0 60px; }
    .container { width: fit-content; margin: 0 auto; padding: 20px; }
    h1, h3, p, table, button, #jokerArea { margin-left:auto; margin-right:auto; width: fit-content; }
    p:not(:has(label)) { text-align:left; max-width:600px; margin-left:auto; margin-right:auto; }
    .tile-container { display:flex; flex-wrap:wrap; justify-content:center; margin:10px 0; width:250px; min-height:48px; border:1px dashed #eee; padding:5px; box-sizing:border-box; }
    #drawnTileArea { min-height:48px; display:flex; justify-content:center; align-items:center; margin:10px 0; width:250px; border:1px dashed #ccc; box-sizing:border-box; }
    .board { display:flex; justify-content:flex-start; margin:20px 0; width:880px; border:1px solid #555; padding:2px; box-sizing:border-box; }
    .tile, .cell { width:40px; height:40px; border:1px solid #000; margin:2px; line-height:40px; font-size:16px; font-weight:bold; text-align:center; box-sizing:border-box; flex-shrink:0; }
    .tile { background:#fff; cursor:default; }
    #drawnTileArea .tile { margin:0; }
    .highlight { animation: glow 1s infinite alternate; border-color: #07f; }
    .recommended { animation: recommended-glow 0.8s infinite alternate; border-color: #0a0; }
    @keyframes recommended-glow { from { background: rgba(144,238,144,.3); } to { background: rgba(144,238,144,.8); } }
    .cell { background:#f0f0f0; cursor:pointer; }
    .board .cell:nth-child(1),
    .board .cell:nth-child(6),
    .board .cell:nth-child(11),
    .board .cell:nth-child(16) { background:#D0F0FF; }
    #player { font-size:16px; padding:5px; margin-bottom:10px; display:inline-block; width:150px; box-sizing:border-box; }
    p label { display:inline-block; margin-right:5px; }
    p:has(label) { text-align:center; max-width:none; }
    #jokerSelect, #resetBtn, button { margin:10px 5px; font-size:16px; padding:8px 15px; cursor:pointer; }
    #warning { color:#d00; font-weight:bold; min-height:1.2em; margin-bottom:10px; }

    table.score-table { margin:20px auto; border-collapse:collapse; font-size:14px; width:fit-content; }
    .shaded { background:#f2f2f2; }
    @keyframes glow { from { background:#fff; } to { background:#ddd; } }

   /* ë­í‚¹ 2ì—´ ë°°ì¹˜ + ì›”ë³„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .rankings-wrap { display:flex; gap:16px; justify-content:center; align-items:flex-start; flex-wrap:wrap; max-width:660px; margin:20px auto; }
    #rankingAreaMonthly { border:1px solid #ccc; padding:20px; background:#f9f9f9; text-align:left; width:300px; }
    .month-control select { padding:4px 8px; }
    /* ë­í‚¹ ë ˆì´ì•„ì›ƒ */
    .rankings-wrap{ display:flex; gap:16px; justify-content:center; align-items:flex-start; flex-wrap:wrap; margin-top:30px; }
    .ranking-card{ width:300px; border:1px solid #ccc; background:#f9f9f9; padding:20px; text-align:left; }
    .ranking-card h3{ text-align:center; margin-bottom:12px; }
    #rankingList, #rankingListMonthly{ list-style:none; padding:0; margin:0; }
    #rankingList li, #rankingListMonthly li{ padding:5px 0; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; }
    #rankingList li:last-child, #rankingListMonthly li:last-child{ border-bottom:none; }
    .rank-name{ font-weight:700; }
    .rank-score{ color:#07f; }
    .rank-date{ font-size:.8em; color:#777; }
    .month-control{ margin-bottom:10px; text-align:center; }
    .month-control select{ padding:4px 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ìŠ¤íŠ¸ë¦¼ìŠ¤ ì›¹ì•± v15</h1>
    <p>
    <p>ìŠ¤íŠ¸ë¦¼ìŠ¤ ê²Œì„ì€ 40ê°œì˜ íƒ€ì¼ ì¤‘ 20ê°œë¥¼ ë½‘ì•„ì„œ ë³´ë“œì— ë°°ì¹˜í•˜ëŠ” ê²Œì„ì…ë‹ˆë‹¤.</p>
    <p>íƒ€ì¼ì„ ì—°ì†í•˜ì—¬ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ë°°ì¹˜í• ìˆ˜ë¡ ë†’ì€ ì ìˆ˜ë¥¼ ë°›ìŠµë‹ˆë‹¤.</p>
    <p>ìˆ«ìê°€ ê°™ì€ íƒ€ì¼ì€ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì¸ì •ë©ë‹ˆë‹¤.</p>
    <p>íƒ€ì¼ì„ í•˜ë‚˜ ë½‘ìœ¼ë©´ ë°˜ë“œì‹œ ë³´ë“œì— ë°°ì¹˜ë¥¼ í•´ì•¼ ë‹¤ìŒ íƒ€ì¼ì„ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p>[ë‹¤ìŒ íƒ€ì¼ ë½‘ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ 1ê°œì”© ë¬´ì‘ìœ„ë¡œ íƒ€ì¼ì„ ë½‘ìŠµë‹ˆë‹¤.</p>
    <p>ë½‘íŒ íƒ€ì¼ì€ ë°˜ì§ì´ë©° ê°•ì¡°ë˜ê³ , 20ì¹¸ ë³´ë“œ ì¤‘ ì›í•˜ëŠ” ë¹ˆ ìœ„ì¹˜ì— í´ë¦­í•˜ì—¬ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p><strong>[ì¶”ì²œ ë°›ê¸°] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜„ì¬ ë½‘íŒ íƒ€ì¼ì„ ì–´ë””ì— ë†“ì•„ì•¼ ê°€ì¥ ë†’ì€ ì ìˆ˜ë¥¼ ë°›ì„ì§€ ì¶”ì²œí•´ì¤ë‹ˆë‹¤.</strong></p>
    <p>â˜†ì€ ì¡°ì»¤ì´ë©°, ë§ˆì§€ë§‰ì— 1~30ê¹Œì§€ì˜ ì›í•˜ëŠ” ìˆ«ìë¡œ ì§€ì •ë©ë‹ˆë‹¤.</p>
    <p>20ì¹¸ ë³´ë“œë¥¼ ëª¨ë‘ ì±„ìš°ë©´ ì ìˆ˜ê°€ ê³„ì‚°ë©ë‹ˆë‹¤.</p>

    <h3>ğŸ§® ì ìˆ˜í‘œ</h3>
    <table class="score-table">
      <tr><td class="shaded">1ì¹¸</td><td>0ì </td><td class="shaded">2ì¹¸</td><td>1ì </td><td class="shaded">3ì¹¸</td><td>3ì </td><td class="shaded">4ì¹¸</td><td>5ì </td><td class="shaded">5ì¹¸</td><td>7ì </td></tr>
      <tr><td class="shaded">6ì¹¸</td><td>9ì </td><td class="shaded">7ì¹¸</td><td>11ì </td><td class="shaded">8ì¹¸</td><td>15ì </td><td class="shaded">9ì¹¸</td><td>20ì </td><td class="shaded">10ì¹¸</td><td>25ì </td></tr>
      <tr><td class="shaded">11ì¹¸</td><td>30ì </td><td>12ì¹¸</td><td>35ì </td><td class="shaded">13ì¹¸</td><td>40ì </td><td class="shaded">14ì¹¸</td><td>50ì </td><td class="shaded">15ì¹¸</td><td>60ì </td></tr>
      <tr><td class="shaded">16ì¹¸</td><td>70ì </td><td class="shaded">17ì¹¸</td><td>85ì </td><td class="shaded">18ì¹¸</td><td>100ì </td><td class="shaded">19ì¹¸</td><td>150ì </td><td class="shaded">20ì¹¸</td><td>300ì </td></tr>
    </table>

    <p><label for="player">ì´ë¦„:</label> <input type="text" id="player" /></p>

    <h3>ë‚¨ì€ íƒ€ì¼</h3>
    <div class="tile-container" id="tileContainer"></div>

    <h3>ë½‘ì€ íƒ€ì¼ (ë³´ë“œì— ë°°ì¹˜í•˜ì„¸ìš”)</h3>
    <div id="drawnTileArea"></div>

    <button id="drawBtn">ë‹¤ìŒ íƒ€ì¼ ë½‘ê¸°</button>
    <button id="recommendBtn" disabled>ì¶”ì²œ ë°›ê¸°</button>
    <button id="resetBtn" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>

    <div id="warning"></div>
    <h3>20ì¹¸ ë³´ë“œ</h3>
    <div class="board" id="board"></div>

    <div id="jokerArea" style="display:none;">
      <label for="jokerSelect">â˜† ê°’ì„ ì„ íƒ: </label>
      <select id="jokerSelect"></select>
      <button onclick="confirmJoker()">í™•ì •</button>
    </div>

    <p id="scoreBreakdown"></p>
    <p>ì ìˆ˜: <span id="score">0</span></p>
    <button id="submitBtn" disabled>ê²°ê³¼ ì €ì¥</button>

    <!-- ë­í‚¹ íŒ¨ë„: ì „ì²´ + ì›”ë³„ -->
    <div class="rankings-wrap">
      <!-- ì „ì²´ ë­í‚¹ -->
      <div id="rankingArea" class="ranking-card">
     <h3>ğŸ† ì—­ëŒ€ ìµœê³  ì ìˆ˜ ë­í‚¹</h3>
     <ul id="rankingList"></ul>
    </div>

    <!-- ì›”ë³„ ë­í‚¹ -->
    <div id="rankingAreaMonthly" class="ranking-card">
     <h3>ğŸ“… ì›”ë³„ ë­í‚¹</h3>
     <div class="month-control">
      <label>ì›” ì„ íƒ: <select id="monthSelect"></select></label>
    </div>
    <ul id="rankingListMonthly"></ul>
  </div>
</div>

  </div>

  <!-- ====== ì—¬ê¸°ë¶€í„°: ê²Œì„ ë¡œì§ + ë­í‚¹ ì—°ë™ ====== -->
  <script>
    /* ---------- ê²Œì„ ë°ì´í„° ---------- */
    const scoreTable = {1:0,2:1,3:3,4:5,5:7,6:9,7:11,8:15,9:20,10:25,11:30,12:35,13:40,14:50,15:60,16:70,17:85,18:100,19:150,20:300};

    let allTiles = [];
    for (let i=1;i<=30;i++){ const c=(i>=11&&i<=19)?2:1; for(let j=0;j<c;j++) allTiles.push(i); }
    allTiles.push('*');

    const tileContainer = document.getElementById("tileContainer");
    const drawnTileArea = document.getElementById("drawnTileArea");
    const board = document.getElementById("board");
    const submitBtn = document.getElementById("submitBtn");
    const jokerArea = document.getElementById("jokerArea");
    const jokerSelect = document.getElementById("jokerSelect");
    const scoreBreakdown = document.getElementById("scoreBreakdown");
    const warning = document.getElementById("warning");
    const drawButton = document.getElementById("drawBtn");
    const recommendBtn = document.getElementById('recommendBtn');
    const rankingList = document.getElementById('rankingList');

    let remainingTiles = [...allTiles];
    let activeTile = null;
    let placedCount = 0;
    let drawOrder = [];
    let currentRecommendationElement = null;

    function renderBoard(){
      board.innerHTML = '';
      for (let i=0;i<20;i++){
        const div=document.createElement('div');
        div.className='cell'; div.dataset.index=i;
        div.addEventListener('click', handleCellClick);
        board.appendChild(div);
      }
    }
    function renderRemainingTiles(){
      tileContainer.innerHTML='';
      remainingTiles.forEach(num=>{
        const div=document.createElement('div');
        div.className='tile';
        div.textContent = (num==='*')?'â˜†':num;
        tileContainer.appendChild(div);
      });
    }

    function getScoreFromBoard(arr){
      let total=0, len=0, last=-Infinity;
      for (let i=0;i<arr.length;i++){
        const v=parseInt(arr[i],10);
        if (isNaN(v)){ if (len>1) total+= (scoreTable[len]||0); len=0; last=-Infinity; continue; }
        if (len===0 || v>=last){ len++; } else { if (len>1) total+=(scoreTable[len]||0); len=1; }
        last=v;
      }
      if (len>1) total+=(scoreTable[len]||0);
      return total;
    }

    function drawNextTile(){
      if (activeTile){ warning.textContent="ë½‘ì€ íƒ€ì¼ì„ ë¨¼ì € ë°°ì¹˜í•˜ì„¸ìš”."; return; }
      if (placedCount>=20){ drawButton.disabled=true; return; }
      if (!remainingTiles.length){ warning.textContent="íƒ€ì¼ì´ ì—†ìŠµë‹ˆë‹¤."; return; }
      warning.textContent="";

      const idx=Math.floor(Math.random()*remainingTiles.length);
      const val=remainingTiles[idx];
      drawOrder.push(val);
      const tileEl=tileContainer.children[idx];
      if (!tileEl){ warning.textContent="ì˜¤ë¥˜: íƒ€ì¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; return; }
      drawnTileArea.appendChild(tileEl);
      tileEl.classList.add('highlight');
      remainingTiles.splice(idx,1);
      renderRemainingTiles();
      activeTile={value:val};
      drawButton.disabled=true; recommendBtn.disabled=false;
    }
    drawButton.addEventListener('click', drawNextTile);

    function handleCellClick(e){
      const cell=e.target;
      if (activeTile && cell.textContent===''){
        cell.textContent = (activeTile.value==='*')?'â˜†':activeTile.value;
        cell.classList.add('placed');
        drawnTileArea.innerHTML='';
        placedCount++; activeTile=null; warning.textContent="";
        removeRecommendationHighlight();
        if (placedCount<20){ drawButton.disabled=false; recommendBtn.disabled=true; }
        else { drawButton.disabled=true; recommendBtn.disabled=true; setTimeout(endGame, 100); }
      } else if (!activeTile){ warning.textContent="ë¨¼ì € íƒ€ì¼ì„ ë½‘ì•„ì£¼ì„¸ìš”."; }
      else if (cell.textContent!==''){ warning.textContent="ì´ë¯¸ ë†“ì¸ ì¹¸ì…ë‹ˆë‹¤."; }
    }

    function endGame(){
      warning.textContent="ë³´ë“œê°€ ë‹¤ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤!";
      const hasJoker = Array.from(board.children).some(c=>c.textContent==='â˜†');
      if (hasJoker){
        jokerArea.style.display='block';
        jokerSelect.innerHTML='';
        for (let i=1;i<=30;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; jokerSelect.appendChild(o); }
        jokerSelect.value=15;
        warning.textContent="ì¡°ì»¤ ê°’ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
      } else { calculateScore(); }
    }

    function confirmJoker(){
      const v=parseInt(jokerSelect.value,10);
      const cell=Array.from(board.children).find(c=>c.textContent==='â˜†');
      if (cell && !isNaN(v)){ cell.textContent=v; } else { warning.textContent="ì¡°ì»¤ ê°’ì„ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•´ì£¼ì„¸ìš”."; return; }
      jokerArea.style.display='none'; warning.textContent=""; calculateScore();
    }

    function calculateScore(){
      const vals = Array.from(board.children).map(c=>c.textContent);
      const total = getScoreFromBoard(vals);
      document.getElementById('score').textContent = total;

      // ê°„ë‹¨í•œ êµ¬ê°„ ì„¤ëª…
      let breakdown="ì ìˆ˜ ìƒì„¸: ";
      let len=0, last=-Infinity, seq=[]; const parts=[];
      for (const t of vals){
        const v=parseInt(t,10);
        if (isNaN(v)){ if (len>1){ parts.push(`[${seq.join('â†’')}] ${len}ì¹¸(${scoreTable[len]||0}ì )`); } len=0; last=-Infinity; seq=[]; continue; }
        if (len===0 || v>=last){ len++; seq.push(v); } else { if (len>1){ parts.push(`[${seq.join('â†’')}] ${len}ì¹¸(${scoreTable[len]||0}ì )`);} len=1; seq=[v]; }
        last=v;
      }
      if (len>1){ parts.push(`[${seq.join('â†’')}] ${len}ì¹¸(${scoreTable[len]||0}ì )`); }
      breakdown += parts.join(' + ') || "ì—°ì† êµ¬ê°„ ì—†ìŒ(2ì¹¸ ì´ìƒ)";
      scoreBreakdown.textContent = breakdown;
      submitBtn.disabled=false;
    }

    submitBtn.addEventListener('click', submitResult);
    function submitResult(){
      const playerName = (document.getElementById('player').value || '').trim() || 'ìµëª…';
      const finalScore = parseInt(document.getElementById('score').textContent||'0',10);
      const finalBoardState = Array.from(board.children).map(c=>c.textContent);
      const drawOrderState = drawOrder.map(v=>v==='*'?'â˜†':v);
      alert(`${playerName}ë‹˜ì˜ ìµœì¢… ì ìˆ˜ëŠ” ${finalScore}ì ì…ë‹ˆë‹¤!`);
      saveRanking(playerName, finalScore); // ë¡œì»¬
      gasSave({name:playerName, score:finalScore, tiles:finalBoardState, order:drawOrderState, date:new Date().toLocaleString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})})
        .then(()=> refreshRanking());
    }

    /* ---------- ë¡œì»¬ ë­í‚¹ (í´ë°±) ---------- */
    const RANKING_KEY='streams_rankings';
    function getRankings(){ const s=localStorage.getItem(RANKING_KEY); return s?JSON.parse(s):[]; }
    function saveRanking(name,score){
      let arr=getRankings();
      arr.push({name,score,date:new Date().toLocaleString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})});
      arr.sort((a,b)=>(b.score===a.score)?(new Date(a.date)-new Date(b.date)):(b.score-a.score));
      arr=arr.slice(0,10); localStorage.setItem(RANKING_KEY, JSON.stringify(arr)); displayRanking();
    }
    function displayRanking(){
      const ul=rankingList; ul.innerHTML='';
      const arr=getRankings();
      if (!arr.length){ ul.innerHTML='<li>ì•„ì§ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; return; }
      arr.forEach((e,i)=>{
        const li=document.createElement('li');
        li.innerHTML=`<span class="rank-name">${i+1}. ${e.name}</span><span><span class="rank-score">${e.score}ì </span> <span class="rank-date">(${e.date})</span></span>`;
        ul.appendChild(li);
      });
    }

    /* ---------- GAS ì €ì¥ ì—”ë“œí¬ì¸íŠ¸ ---------- */
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzu8RE7GqIQdZeRUG2cW2qe_FWomSjlOGqsLMEVi6369gw1xtqq2J6ZD5xPQKKaLubqLQ/exec';
    async function gasSave({name, score, tiles, order, date}){
      try{
        if (!GAS_ENDPOINT) return;
        const params = new URLSearchParams({ action:'save', name:String(name||'ìµëª…'), score:String(score||0),
                                             tiles:Array.isArray(tiles)?tiles.join(','):String(tiles||''),
                                             order:Array.isArray(order)?order.join(','):String(order||''),
                                             date:String(date||'') });
        await fetch(`${GAS_ENDPOINT}?${params.toString()}`, {method:'GET'});
      }catch(e){ console.warn('GAS save failed:', e); }
    }

    /* ---------- GViz ì¡°íšŒ (ì „ì²´/ì›”ë³„) ---------- */
    const SHEET_ID   = '1jBL_ZHXPJUCCopdPm-SVjmQLDw_zoQHoO6K9vJ95CiI';
    const SHEET_NAME = 'ìŠ¤íŠ¸ë¦¼ìŠ¤';
    async function gasFetchTop(){
      const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&range=A2:D`;
      const res=await fetch(url,{method:'GET'}); if(!res.ok) throw new Error('HTTP '+res.status);
      const txt=await res.text(); const match=txt.match(/\{[\s\S]*\}/); if(!match) throw new Error('Failed to parse GViz JSON');
      const data=JSON.parse(match[0]);
      const rows=(data.table?.rows||[]).map(r=>({
        index:r.c?.[0]?.v ?? '',
        date:(r.c?.[1]?.f ?? r.c?.[1]?.v ?? ''),
        name:r.c?.[2]?.v ?? 'ìµëª…',
        score:Number(r.c?.[3]?.v ?? 0)
      })).filter(r=>!Number.isNaN(r.score));
      rows.sort((a,b)=>(b.score===a.score)?String(a.date).localeCompare(String(b.date)):(b.score-a.score));
      return rows.slice(0,50); // ìƒìœ„ 50ê¹Œì§€ ë°›ì•„ë‘ê³  í•„í„°ë§ì—ì„œ 10ê°œ ì‚¬ìš©
    }

    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function renderServerRanking(rows){
      const ul=document.getElementById('rankingList'); if(!ul) return; ul.innerHTML='';
      if(!rows || !rows.length){ ul.innerHTML='<li>ì„œë²„ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; return; }
      rows.slice(0,10).forEach((r,i)=>{
        const li=document.createElement('li');
        const d=r.date||r.saved_at||'';
        li.innerHTML=`<span class="rank-name">${i+1}. ${escapeHtml(r.name||'ìµëª…')}</span><span><span class="rank-score">${escapeHtml(r.score)}</span> <span class="rank-date">(${escapeHtml(d)})</span></span>`;
        const s=li.querySelector('.rank-score'); if(s && !/ì $/.test(s.textContent)) s.textContent+= 'ì ';
        ul.appendChild(li);
      });
    }

    function monthKeyFrom(dateStr){ const s=String(dateStr||''); const m=s.match(/^(\d{4})[-/.](\d{1,2})/); if(!m) return ''; return `${m[1]}-${String(m[2]).padStart(2,'0')}`; }
    function buildMonthOptions(rows){
      const sel=document.getElementById('monthSelect'); if(!sel) return;
      const keys=Array.from(new Set(rows.map(r=>monthKeyFrom(r.date||r.saved_at)).filter(Boolean)));
      keys.sort((a,b)=>b.localeCompare(a));
      sel.innerHTML='';
      const now=new Date(); const currentKey=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      keys.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); });
      if (keys.includes(currentKey)) sel.value=currentKey; else if(keys.length) sel.value=keys[0];
    }
    function renderMonthlyRankingFor(monthKey, rows){
      const ul=document.getElementById('rankingListMonthly'); if(!ul) return; ul.innerHTML='';
      const monthly=rows.filter(r=>monthKeyFrom(r.date||r.saved_at)===monthKey);
      if(!monthly.length){ ul.innerHTML='<li>ì´ ë‹¬ì˜ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; return; }
      monthly.slice(0,10).forEach((r,i)=>{
        const li=document.createElement('li'); const d=r.date||r.saved_at||'';
        li.innerHTML=`<span class="rank-name">${i+1}. ${escapeHtml(r.name||'ìµëª…')}</span><span><span class="rank-score">${escapeHtml(r.score)}</span> <span class="rank-date">(${escapeHtml(d)})</span></span>`;
        const s=li.querySelector('.rank-score'); if(s && !/ì $/.test(s.textContent)) s.textContent+='ì ';
        ul.appendChild(li);
      });
    }

    async function refreshRanking(){
      try{
        const data=await gasFetchTop();
        renderServerRanking(data); // ì „ì²´
        buildMonthOptions(data);
        const sel=document.getElementById('monthSelect');
        if (sel && sel.value){ renderMonthlyRankingFor(sel.value, data); sel.onchange=()=>renderMonthlyRankingFor(sel.value,data); }
      }catch(e){
        console.warn('Server ranking unavailable, falling back to local ranking.', e);
        if (typeof displayRanking==='function') displayRanking();
      }
    }

    // ì´ˆê¸° ë Œë”
    document.addEventListener('DOMContentLoaded', ()=>{
      renderRemainingTiles(); renderBoard(); drawButton.disabled=false; recommendBtn.disabled=true; submitBtn.disabled=true;
      displayRanking(); // ë¡œì»¬ í´ë°± ë¨¼ì €
      refreshRanking(); // ì„œë²„ ì‹œë„
    });
  </script>

<script>
/* ===== ì›”ë³„ ë­í‚¹ ì „ìš© ì½”ë“œ (ê¸°ì¡´ ì½”ë“œì™€ ë…ë¦½) ===== */

/* ë‚ ì§œ "YYYY-MM" í‚¤ ë½‘ê¸° */
function monthKeyFrom(dateStr){
  const s = String(dateStr || '');
  const m = s.match(/^(\d{4})[-/.](\d{1,2})/);
  if (!m) return '';
  return `${m[1]}-${String(m[2]).padStart(2,'0')}`;
}

/* GViz ì „ì²´ í–‰ ì½ê¸°: ê¸°ì¡´ gasFetchTopì€ ìƒìœ„ 10ê°œë§Œì´ë¯€ë¡œ, ì›”ë³„ìš©ìœ¼ë¡œ ì „ì²´ë¥¼ ìƒˆë¡œ ì½ìŠµë‹ˆë‹¤ */
async function gasFetchAllRows(){
  // ê¸°ì¡´ GAS ë¸”ë¡ì—ì„œ ì“°ëŠ” ìƒìˆ˜ ì¬ì‚¬ìš© (ì´ë¯¸ íŒŒì¼ í•˜ë‹¨ì— ì„ ì–¸ë˜ì–´ ìˆìŒ)
  // const SHEET_ID = '...'; const SHEET_NAME = '...';
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&range=A2:D`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP ' + res.status);
  const txt = await res.text();
  const match = txt.match(/\{[\s\S]*\}/);
  if(!match) throw new Error('Failed to parse GViz JSON');
  const data = JSON.parse(match[0]);

  // A=index, B=saved_at, C=name, D=score
  const rows = (data.table?.rows || []).map(r => ({
    index : r.c?.[0]?.v ?? '',
    date  : (r.c?.[1]?.f ?? r.c?.[1]?.v ?? ''),
    name  : r.c?.[2]?.v ?? 'ìµëª…',
    score : Number(r.c?.[3]?.v ?? 0)
  })).filter(r => !Number.isNaN(r.score));

  // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ, ë™ì ì‹œ ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ
  rows.sort((a,b) => (b.score === a.score) ? String(a.date).localeCompare(String(b.date)) : b.score - a.score);
  return rows; // ì „ì²´ ë°˜í™˜
}

/* ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë§Œë“¤ê¸° (ì´ë²ˆ ë‹¬ ìš°ì„  ì„ íƒ) */
function buildMonthOptions(rows){
  const sel = document.getElementById('monthSelect');
  if (!sel) return;
  const keys = [...new Set(rows.map(r => monthKeyFrom(r.date)).filter(Boolean))].sort((a,b)=>b.localeCompare(a));
  sel.innerHTML = '';
  keys.forEach(k => {
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = k; sel.appendChild(opt);
  });
  const now = new Date();
  const current = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  if (keys.includes(current)) sel.value = current;
  else if (keys.length) sel.value = keys[0];
}

/* ì„ íƒëœ ì›”ì˜ Top10 ë Œë” */
function renderMonthlyRankingFor(monthKey, rows){
  const ul = document.getElementById('rankingListMonthly');
  if (!ul) return;
  ul.innerHTML = '';
  const monthly = rows.filter(r => monthKeyFrom(r.date) === monthKey).slice(0,10);
  if (!monthly.length){
    ul.innerHTML = '<li>ì´ ë‹¬ì˜ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    return;
  }
  monthly.forEach((r,i) => {
    const li = document.createElement('li');
    const d = r.date || '';
    li.innerHTML = `
      <span class="rank-name">${i+1}. ${r.name}</span>
      <span><span class="rank-score">${r.score}ì </span> <span class="rank-date">(${d})</span></span>`;
    ul.appendChild(li);
  });
}

/* í˜ì´ì§€ ë¡œë“œ ì‹œ ì›”ë³„ ë­í‚¹ ì´ˆê¸°í™” (ì „ì²´ ë­í‚¹ ë¡œì§ì€ ê¸°ì¡´ ì½”ë“œ ìœ ì§€) */
document.addEventListener('DOMContentLoaded', async () => {
  try{
    const rows = await gasFetchAllRows();  // ì „ì²´ ë°ì´í„°
    buildMonthOptions(rows);
    const sel = document.getElementById('monthSelect');
    if (sel && sel.options && sel.options.length){
      renderMonthlyRankingFor(sel.value, rows);
      sel.onchange = () => renderMonthlyRankingFor(sel.value, rows);
    }
  }catch(e){
    console.warn('ì›”ë³„ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
    const ul = document.getElementById('rankingListMonthly');
    if (ul) ul.innerHTML = '<li>ì›”ë³„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</li>';
  }
});
</script>
</body>
</html>
