<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>스트림스 웹앱</title>
  <style>
    body {
      background-color: white;
      color: black;
      font-family: sans-serif;
      text-align: center;
    }
    .tile-container, .board {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px;
    }
    .tile, .cell {
      width: 40px;
      height: 40px;
      border: 1px solid black;
      margin: 2px;
      line-height: 40px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .tile {
      background-color: white;
    }
    .tile.glow {
      animation: glow 1s infinite alternate;
    }
    .cell {
      background-color: #f0f0f0;
    }
    @keyframes glow {
      from { background-color: #fff; }
      to { background-color: #ddd; }
    }
  </style>
</head>
<body>
  <h1>스트림스 웹앱</h1>
  <p>이름: <input type="text" id="player" /></p>
  <div class="tile-container" id="tileContainer"></div>
  <h3>20칸 보드</h3>
  <div class="board" id="board"></div>
  <p>점수: <span id="score">0</span></p>
  <button onclick="submitResult()">결과 저장</button>

  <script>
    const scoreTable = {
      1: 0, 2: 1, 3: 3, 4: 5, 5: 7, 6: 9, 7: 11, 8: 15, 9: 20, 10: 25,
      11: 30, 12: 35, 13: 40, 14: 50, 15: 60, 16: 70, 17: 85, 18: 100, 19: 150, 20: 300
    };

    const tiles = [];
    for (let i = 1; i <= 30; i++) {
      const count = (i >= 11 && i <= 19) ? 2 : 1;
      for (let j = 0; j < count; j++) tiles.push(i);
    }
    tiles.push('*'); // 조커

    const shuffled = tiles.sort(() => Math.random() - 0.5);
    const tileContainer = document.getElementById("tileContainer");
    const board = document.getElementById("board");

    shuffled.forEach((num, i) => {
      const div = document.createElement("div");
      div.className = "tile glow";
      div.draggable = true;
      div.textContent = num;
      div.id = `tile-${i}`;
      div.ondragstart = e => e.dataTransfer.setData("text/plain", div.id);
      tileContainer.appendChild(div);
    });

    for (let i = 0; i < 20; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.ondragover = e => e.preventDefault();
      cell.ondrop = e => {
        const id = e.dataTransfer.getData("text/plain");
        const tile = document.getElementById(id);
        if (!cell.hasChildNodes()) {
          cell.appendChild(tile);
          updateScore();
        }
      };
      board.appendChild(cell);
    }

    function updateScore() {
      const nums = Array.from(board.children).map(cell => {
        const val = cell.textContent;
        return val && val !== '*' ? parseInt(val) : null;
      });
      let maxSeq = 0, curr = 0;
      for (let i = 0; i < nums.length; i++) {
        if (i === 0 || nums[i] === null || (nums[i - 1] !== null && nums[i] <= nums[i - 1])) {
          curr = nums[i] !== null ? 1 : 0;
        } else {
          curr++;
        }
        maxSeq = Math.max(maxSeq, curr);
      }
      document.getElementById("score").textContent = scoreTable[maxSeq] || 0;
    }

    function submitResult() {
      const name = document.getElementById("player").value;
      const tilesUsed = Array.from(board.children).map(cell => cell.textContent || "");
      const score = document.getElementById("score").textContent;
      if (!name) return alert("이름을 입력해주세요.");
      fetch("https://script.google.com/macros/s/AKfycbxESJ7DK8_QyDADd5271qYWLtb6_UD3Q7qs25zcadrfmqZHAAFlUF4tYYHQvlJWQcBSgQ/exec", {
        method: "POST",
        body: JSON.stringify({ name: name, tiles: tilesUsed, score: score })
      }).then(res => alert("기록 완료!"));
    }
  </script>
</body>
</html>
