<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>스트림스 웹앱 v3</title>
  <style>
    body {
      background-color: white;
      color: black;
      font-family: sans-serif;
      text-align: center;
    }
    .tile-container, .board {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px;
    }
    .tile, .cell {
      width: 40px;
      height: 40px;
      border: 1px solid black;
      margin: 2px;
      line-height: 40px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .tile {
      background-color: white;
    }
    .highlight {
      animation: glow 1s infinite alternate;
    }
    .cell {
      background-color: #f0f0f0;
    }
    @keyframes glow {
      from { background-color: #fff; }
      to { background-color: #ddd; }
    }
  </style>
</head>
<body>
  <h1>스트림스 웹앱 v3</h1>
  <p>이름: <input type="text" id="player" /></p>
  <div class="tile-container" id="tileContainer"></div>
  <button onclick="drawNextTile()">다음 타일 뽑기</button>
  <h3>20칸 보드</h3>
  <div class="board" id="board"></div>
  <p>점수: <span id="score">0</span></p>
  <button onclick="submitResult()" disabled id="submitBtn">결과 저장</button>

  <script>
    const scoreTable = {
      1: 0, 2: 1, 3: 3, 4: 5, 5: 7, 6: 9, 7: 11, 8: 15, 9: 20, 10: 25,
      11: 30, 12: 35, 13: 40, 14: 50, 15: 60, 16: 70, 17: 85, 18: 100, 19: 150, 20: 300
    };

    let tiles = [];
    for (let i = 1; i <= 30; i++) {
      const count = (i >= 11 && i <= 19) ? 2 : 1;
      for (let j = 0; j < count; j++) tiles.push(i);
    }
    tiles.push('*');
    tiles.sort((a, b) => (a === '*' ? 1 : b === '*' ? -1 : a - b));

    const tileContainer = document.getElementById("tileContainer");
    const board = document.getElementById("board");
    const submitBtn = document.getElementById("submitBtn");
    let remaining = [...tiles];
    let activeTile = null;
    let placedCount = 0;

    function renderTiles() {
      tileContainer.innerHTML = '';
      remaining.forEach((num, i) => {
        const div = document.createElement("div");
        div.className = "tile";
        div.textContent = num;
        div.id = `tile-${i}`;
        tileContainer.appendChild(div);
      });
    }

    function drawNextTile() {
      if (activeTile !== null || remaining.length === 0) return;
      const idx = Math.floor(Math.random() * remaining.length);
      activeTile = { index: idx, value: remaining[idx] };
      const tileDiv = document.getElementById(`tile-${idx}`);
      tileDiv.classList.add("highlight");
      tileDiv.draggable = true;
      tileDiv.ondragstart = e => e.dataTransfer.setData("text/plain", idx);
    }

    function initializeBoard() {
      for (let i = 0; i < 20; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.ondragover = e => e.preventDefault();
        cell.ondrop = e => {
          if (!cell.hasChildNodes() && activeTile !== null) {
            const idx = activeTile.index;
            const tile = document.getElementById(`tile-${idx}`);
            cell.textContent = tile.textContent;
            remaining.splice(idx, 1);
            renderTiles(); // re-render without removed tile
            activeTile = null;
            placedCount++;
            if (placedCount === 20) {
              updateScore();
              submitBtn.disabled = false;
            }
          }
        };
        board.appendChild(cell);
      }
    }

    function updateScore() {
      const nums = Array.from(board.children).map(cell => {
        const val = cell.textContent;
        return val && val !== '*' ? parseInt(val) : null;
      });
      let totalScore = 0;
      let currentLength = 0;
      for (let i = 0; i < nums.length; i++) {
        if (nums[i] === null) {
          if (currentLength > 0) {
            totalScore += scoreTable[currentLength] || 0;
            currentLength = 0;
          }
          continue;
        }
        if (currentLength === 0 || (i > 0 && nums[i - 1] !== null && nums[i] > nums[i - 1])) {
          currentLength++;
        } else {
          totalScore += scoreTable[currentLength] || 0;
          currentLength = 1;
        }
      }
      if (currentLength > 0) {
        totalScore += scoreTable[currentLength] || 0;
      }
      document.getElementById("score").textContent = totalScore;
    }

    function submitResult() {
      const name = document.getElementById("player").value;
      const tilesUsed = Array.from(board.children).map(cell => cell.textContent || "");
      const score = document.getElementById("score").textContent;
      if (!name) return alert("이름을 입력해주세요.");
      fetch("https://script.google.com/macros/s/AKfycbxESJ7DK8_QyDADd5271qYWLtb6_UD3Q7qs25zcadrfmqZHAAFlUF4tYYHQvlJWQcBSgQ/exec", {
        method: "POST",
        body: JSON.stringify({ name: name, tiles: tilesUsed, score: score })
      }).then(res => alert("기록 완료!"));
    }

    renderTiles();
    initializeBoard();
  </script>
</body>
</html>
