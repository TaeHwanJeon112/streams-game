<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìŠ¤íŠ¸ë¦¼ìŠ¤ ì›¹ì•± v7</title>
  <style>
    body {
      background-color: white;
      color: black;
      font-family: sans-serif;
      text-align: center;
    }
    .tile-container, .board {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px;
    }
    .tile, .cell {
      width: 40px;
      height: 40px;
      border: 1px solid black;
      margin: 2px;
      line-height: 40px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .tile {
      background-color: white;
    }
    .highlight {
      animation: glow 1s infinite alternate;
    }
    .cell {
      background-color: #f0f0f0;
    }
    #jokerSelect, #resetBtn {
      margin: 10px;
      font-size: 16px;
      padding: 5px;
    }
    #warning {
      color: red;
      font-weight: bold;
    }
    table.score-table {
      margin: auto;
      border-collapse: collapse;
    }
    .score-table td {
      padding: 4px 8px;
      border: 1px solid #aaa;
    }
    @keyframes glow {
      from { background-color: #fff; }
      to { background-color: #ddd; }
    }
  </style>
</head>
<body>
  <h1>ìŠ¤íŠ¸ë¦¼ìŠ¤ ì›¹ì•± v7</h1>
  <p style="max-width: 600px; margin: auto; text-align: left;">
    ìŠ¤íŠ¸ë¦¼ìŠ¤ ê²Œì„ì€ 40ê°œì˜ íƒ€ì¼ ì¤‘ 20ê°œë¥¼ ë½‘ì•„ì„œ ë³´ë“œì— ë°°ì¹˜í•˜ëŠ” ê²Œì„ì…ë‹ˆë‹¤.<br>
    íƒ€ì¼ì„ í•˜ë‚˜ ë½‘ìœ¼ë©´ ë°˜ë“œì‹œ 20ì¹¸ ë³´ë“œì— ë°°ì¹˜ë¥¼ í•´ì•¼ ë‹¤ìŒ íƒ€ì¼ì„ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
    íƒ€ì¼ì€ 1~10ê¹Œì§€ 1ê°œ, 11~19ê¹Œì§€ 2ê°œ, 20~30ê¹Œì§€ 1ê°œ, â˜† 1ê°œë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>
    [ë‹¤ìŒ íƒ€ì¼ ë½‘ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ 1ê°œì”© ë¬´ì‘ìœ„ë¡œ íƒ€ì¼ì„ ë½‘ìŠµë‹ˆë‹¤.<br>
    ë½‘íŒ íƒ€ì¼ì€ ë°˜ì§ì´ë©° ê°•ì¡°ë˜ê³ , 20ì¹¸ ë³´ë“œ ì¤‘ ì›í•˜ëŠ” ìœ„ì¹˜ì— ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
    â˜†ì€ ì¡°ì»¤ì´ë©°, ë§ˆì§€ë§‰ì— 1~30ê¹Œì§€ì˜ ì›í•˜ëŠ” ìˆ«ìë¡œ ì§€ì •ë©ë‹ˆë‹¤.<br>
    20ì¹¸ ë³´ë“œë¥¼ ëª¨ë‘ ì±„ìš°ë©´ ì ìˆ˜ê°€ ê³„ì‚°ë©ë‹ˆë‹¤.
  </p>
  <h3>ğŸ§® ì¹¸ ìˆ˜ë³„ ì ìˆ˜í‘œ</h3>
  <table class="score-table">
    <tr><td>1ì¹¸</td><td>0ì </td><td>2ì¹¸</td><td>1ì </td><td>3ì¹¸</td><td>3ì </td><td>4ì¹¸</td><td>5ì </td><td>5ì¹¸</td><td>7ì </td></tr>
    <tr><td>6ì¹¸</td><td>9ì </td><td>7ì¹¸</td><td>11ì </td><td>8ì¹¸</td><td>15ì </td><td>9ì¹¸</td><td>20ì </td><td>10ì¹¸</td><td>25ì </td></tr>
    <tr><td>11ì¹¸</td><td>30ì </td><td>12ì¹¸</td><td>35ì </td><td>13ì¹¸</td><td>40ì </td><td>14ì¹¸</td><td>50ì </td><td>15ì¹¸</td><td>60ì </td></tr>
    <tr><td>16ì¹¸</td><td>70ì </td><td>17ì¹¸</td><td>85ì </td><td>18ì¹¸</td><td>100ì </td><td>19ì¹¸</td><td>150ì </td><td>20ì¹¸</td><td>300ì </td></tr>
  </table>

  <p>ì´ë¦„: <input type="text" id="player" /></p>
  <div class="tile-container" id="tileContainer"></div>
  <button onclick="drawNextTile()">ë‹¤ìŒ íƒ€ì¼ ë½‘ê¸°</button>
  <button onclick="location.reload()" id="resetBtn">ì²˜ìŒìœ¼ë¡œ</button>
  <div id="warning"></div>
  <h3>20ì¹¸ ë³´ë“œ</h3>
  <div class="board" id="board"></div>
  <div id="jokerArea" style="display:none;">
    <label for="jokerSelect">â˜†ë¥¼ ì–´ë–¤ ìˆ«ìë¡œ ê°„ì£¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ? </label>
    <select id="jokerSelect"></select>
    <button onclick="confirmJoker()">í™•ì •</button>
  </div>
  <p id="scoreBreakdown"></p>
  <p>ì ìˆ˜: <span id="score">0</span></p>
  <button onclick="submitResult()" disabled id="submitBtn">ê²°ê³¼ ì €ì¥</button>

  <script>
    const scoreTable = {
      1: 0, 2: 1, 3: 3, 4: 5, 5: 7, 6: 9, 7: 11, 8: 15, 9: 20, 10: 25,
      11: 30, 12: 35, 13: 40, 14: 50, 15: 60, 16: 70, 17: 85, 18: 100, 19: 150, 20: 300
    };

    let tiles = [];
    for (let i = 1; i <= 30; i++) {
      const count = (i >= 11 && i <= 19) ? 2 : 1;
      for (let j = 0; j < count; j++) tiles.push(i);
    }
    tiles.push('*');
    tiles.sort((a, b) => (a === '*' ? 1 : b === '*' ? -1 : a - b));

    const tileContainer = document.getElementById("tileContainer");
    const board = document.getElementById("board");
    const submitBtn = document.getElementById("submitBtn");
    const jokerArea = document.getElementById("jokerArea");
    const jokerSelect = document.getElementById("jokerSelect");
    const scoreBreakdown = document.getElementById("scoreBreakdown");
    const warning = document.getElementById("warning");

    let remaining = [...tiles];
    let activeTile = null;
    let placedCount = 0;
    let drawOrder = [];

    function renderTiles() {
      tileContainer.innerHTML = '';
      remaining.forEach((num, i) => {
        const div = document.createElement("div");
        div.className = "tile";
        div.textContent = num;
        div.id = `tile-${i}`;
        tileContainer.appendChild(div);
      });
    }

    function drawNextTile() {
      if (activeTile !== null) {
        warning.textContent = "íƒ€ì¼ì„ ë°˜ë“œì‹œ ë°°ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.";
        return;
      }
      warning.textContent = "";
      const idx = Math.floor(Math.random() * remaining.length);
      activeTile = { index: idx, value: remaining[idx] };
      drawOrder.push(activeTile.value);
      const tileDiv = document.getElementById(`tile-${idx}`);
      tileDiv.classList.add("highlight");
      tileDiv.draggable = true;
      tileDiv.ondragstart = e => e.dataTransfer.setData("text/plain", idx);
    }

    function initializeBoard() {
      for (let i = 0; i < 20; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.ondragover = e => e.preventDefault();
        cell.ondrop = e => {
          if (!cell.hasChildNodes() && activeTile !== null) {
            const idx = activeTile.index;
            const tile = document.getElementById(`tile-${idx}`);
            cell.textContent = tile.textContent;
            remaining.splice(idx, 1);
            renderTiles();
            activeTile = null;
            placedCount++;
            if (placedCount === 20) {
              if (Array.from(board.children).some(cell => cell.textContent === '*')) {
                jokerSelect.innerHTML = '';
                for (let i = 1; i <= 30; i++) {
                  const opt = document.createElement("option");
                  opt.value = i;
                  opt.textContent = i;
                  jokerSelect.appendChild(opt);
                }
                jokerArea.style.display = 'block';
              } else {
                updateScore();
                submitBtn.disabled = false;
              }
            }
          }
        };
        board.appendChild(cell);
      }
    }

    function confirmJoker() {
      const selected = parseInt(jokerSelect.value);
      Array.from(board.children).forEach(cell => {
        if (cell.textContent === '*') cell.textContent = selected;
      });
      jokerArea.style.display = 'none';
      updateScore();
      submitBtn.disabled = false;
    }

    function updateScore() {
      const nums = Array.from(board.children).map(cell => {
        const val = cell.textContent;
        return val ? parseInt(val) : null;
      });
      let totalScore = 0;
      let currentLength = 0;
      let breakdown = [];
      for (let i = 0; i < nums.length; i++) {
        if (nums[i] === null) {
          if (currentLength > 0) {
            const s = scoreTable[currentLength] || 0;
            breakdown.push(`${currentLength}ì¹¸(${s}ì )`);
            totalScore += s;
            currentLength = 0;
          }
          continue;
        }
        if (currentLength === 0 || (i > 0 && nums[i - 1] !== null && nums[i] >= nums[i - 1])) {
          currentLength++;
        } else {
          const s = scoreTable[currentLength] || 0;
          breakdown.push(`${currentLength}ì¹¸(${s}ì )`);
          totalScore += s;
          currentLength = 1;
        }
      }
      if (currentLength > 0) {
        const s = scoreTable[currentLength] || 0;
        breakdown.push(`${currentLength}ì¹¸(${s}ì )`);
        totalScore += s;
      }
      scoreBreakdown.textContent = breakdown.join(" + ") + ` = ì´ ${totalScore}ì `;
      document.getElementById("score").textContent = totalScore;
    }

    function submitResult() {
      const name = document.getElementById("player").value;
      const tilesUsed = Array.from(board.children).map(cell => cell.textContent || "");
      const score = document.getElementById("score").textContent;
      if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      fetch("https://script.google.com/macros/s/AKfycbxESJ7DK8_QyDADd5271qYWLtb6_UD3Q7qs25zcadrfmqZHAAFlUF4tYYHQvlJWQcBSgQ/exec", {
        method: "POST",
        body: JSON.stringify({ name: name, tiles: tilesUsed, score: score, order: drawOrder })
      }).then(res => alert("ê¸°ë¡ ì™„ë£Œ!"));
    }

    renderTiles();
    initializeBoard();
  </script>
</body>
</html>
